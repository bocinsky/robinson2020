---
title: "Robinson et al. 2020 Supplemental Information: Comparing the Radiocarbon and Tree-ring Records for the Upland US Southwest"
author: "Kyle Bocinsky"
date: "1/12/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Robinson2020)
```

## Summary of methods
Here, we directly compare two large collections of radiocarbon and tree-ring dates drawn from the Upland US Southwest --- roughly defined as the 'Four Corners' states of Arizona, Colorado, New Mexico, and Utah, but excluding the Phoenix and Tucson basins. 

After harmonizing those datasets to with one another and calibrating Radiocarbon dates are drawn from the [DARCY: DATABASE AND REFERENCE HERE], and are available [HERE]. Tree-ring data are those presented in @Bocinsky2016_SA and archived on the Digital Archaeological Record (https://doi.org/10.6067/XCV82J6D7B).

## Study Area

```{r}
# Define the Bocinsky et al. 2016 study area
UUSW <- sf::st_bbox(c(xmin = -113,
                      xmax = -105,
                      ymin = 32,
                      ymax = 38), 
                    crs = 4326) %>%
  sf::st_as_sfc() 

vep

# VEP study areas
vep_study_areas <- 
  list(CMV = villager::get_vep_boundary(version = "vepii_cmv"),
       NRG = villager::get_vep_boundary(version = "vepii_nrg")) %>%
  purrr::map(sf::st_transform,
             crs = 4326) %>%
  purrr::map(tibble::as_tibble) %>%
  dplyr::bind_rows(.id = "Study Area") %>%
  sf::st_as_sf(crs = 4326)



```

## Datasets
These data contain sensitive location information about cultural sites, and are restricted on tDAR. Accordingly, we pre-processed the data using the script below, and provide data as supplemental information without location information represented.
```{r}
# Read in the Bocinsky et al. 2016 tree ring data
# https://doi.org/10.6067/XCV82J6D7B
dendro_data <- 
  readr::read_csv("./data-raw/TreeRing/Bocinsky_et_al_2016_dendrochronology.csv") %>%
  # Convert to spatial object
  sf::st_as_sf(coords = c("LON","LAT"),
               crs = 4326) %>%
  # Crop to SWUS bounding box
  sf::st_intersection(UUSW) %>%
  # Convert dates to BP
  dplyr::mutate(Date_BP = 1950 - Outer_Date_AD,
                Type = ifelse(C_Level %in% c(2,3),
                              "Cutting or Near-cutting",
                              "Non-cutting")) %>%
  # drop C_Level
  dplyr::select(Seq_Number,
                Site_Number,
                Site_Name,
                Lab_Number,
                Type,
                Date_BP) %>%
  dplyr::rename(SiteID = Seq_Number) %T>%
  # Write the output to a new file (geojson)
  sf::write_sf("./data-derived/dendro_data.geojson",
               delete_dsn = TRUE)

# Check R/T
# sf::read_sf("./data-derived/dendro_data.geojson")

```

We draw on the tree-ring date database presented in @Bocinsky2016_SA and archived on the Digital Archaeological Record (https://doi.org/10.6067/XCV82J6D7B) --- `r nrow(readr::read_csv("./data-raw/TreeRing/Bocinsky_et_al_2016_dendrochronology.csv"))` dates from the Upland US Southwest. Here, we use only the subset of those data 

## Preparing the radiocarbon data

```{r}
# Read in the Bocinsky et al. 2016 tree ring data
radiocarbon_data <- #readr::read_csv("./data-raw/Radiocarbon/14C_Raw.csv") %>%
  readr::read_csv("./data-raw/Radiocarbon/0403_sbox_clean.csv") %>%
  # Convert to spatial object
  sf::st_as_sf(coords = c("Long","Lat"),
               crs = 4326) %>%
  # Crop to SWUS bounding box
  sf::st_intersection(SWUS_bbox) %>%
  # Remove Phoenix Basin dates
  sf::st_difference(phx_basin) %>%
  # Select salient columns
  dplyr::select(labnumber,
                date,
                sd,
                #diff,
                #d13,
                #mat,
                #Source,
                Site,
                SiteID) %>%
  dplyr::rename(Lab_Number = labnumber,
                Date_BP = date,
                SD = sd,
                # Diff = diff,
                # Material = mat,
                Site_Number = Site) %>%
  sf::st_intersection("./data-raw/countyp010g/countyp010g.gdb/" %>%
                        sf::st_read() %>%
                        sf::st_transform(4326) %>%
                        dplyr::mutate(County = paste(NAME, STATE, sep = ", ")) %>%
                        dplyr::select(County)) %T>%
  # Write the output to a new file (geojson)
  sf::write_sf("./data-derived/radiocarbon_data.geojson",
               delete_dsn = TRUE)

# Check R/T
# sf::read_sf("./data-derived/radiocarbon_data.geojson")

```


```{r}
radiocarbon_data <-
  sf::read_sf("./data-derived/radiocarbon_data.geojson") %>%
  dplyr::mutate(Type = "Radiocarbon",
                SiteID = SiteID %>% stringr::str_c("Radiocarbon - ", .)) %>%
  dplyr::mutate(`Study Area` = ifelse(County == "Montezuma, CO",
                                      "CMV", 
                                      NA),
                `Study Area` = ifelse(County %in% c("Rio Arriba, NM",
                                                    "Sandoval, NM",
                                                    "Santa Fe, NM",
                                                    "Taos, NM"),
                                      "NRG", 
                                      `Study Area`)) %>%
  dplyr::select(-County)

dendro_data <- 
  sf::read_sf("./data-derived/dendro_data.geojson") %>%
  dplyr::mutate(Type = Type %>% stringr::str_c("Dendro - ", .),
                SiteID = SiteID %>% stringr::str_c("Dendro - ", .),
                SD = 0) %>%
  dplyr::filter(Type == "Dendro - Cutting or Near-cutting") %>%
  dplyr::mutate(Type = "Tree-ring") %>%
  sf::st_join(vep_study_areas) %>%
  dplyr::select(-Site_Name) %>%
  # dplyr::rename(`Study Area` = `Study.Area`) %>%
  dplyr::select(names(radiocarbon_data))

rbind(radiocarbon_data,
      dendro_data) %>%
  sf::st_drop_geometry() %>%
  group_by(Type,`Study Area`) %>%
  dplyr::summarise(Count = n()) %>%
  tidyr::spread(Type, Count)

```

## Preparing the radiocarbon SPDs

```{r}
radiocarbon_spd <-
  radiocarbon_data %>%
  split(.,.$`Study Area`) %>%
  tibble::tibble(`Study Area` = names(.),
                 Dates = .) %>%
  dplyr::bind_rows(tibble::tibble(`Study Area` = "UUSW",
                                  Dates = list(radiocarbon_data))) %>%
  dplyr::rowwise() %>%
  dplyr::mutate(Calibrated = list(Dates %$%
                                    rcarbon::calibrate(x = Date_BP,
                                                       errors = SD,
                                                       calMatrix = TRUE,
                                                       normalised = TRUE)),
                Bins = list(rcarbon::binPrep(sites = Dates$SiteID,
                                             ages = Calibrated,
                                             h = 100)),
                SPD = list(spd(x = Calibrated,
                               bins = Bins,
                               timeRange = c(1949,0),
                               runm = 21))) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Density = SPD %>%
                  purrr::map(function(x){
                    x$grid %>%
                      tibble::as_tibble() %$%
                      tibble::tibble(Type = "Radiocarbon Density",
                                     Date_BP = calBP,
                                     Density = PrDens / sum(PrDens, na.rm = T))
                  })
  ) %T>%
  readr::write_rds("./data-derived/radiocarbon_spd.rds",
                   compress = "gz")

radiocarbon_spd <- readr::read_rds("./data-derived/radiocarbon_spd.rds")

```

To prepare the radiocarbon dataset, we used functions provided by the *rcarbon* package for R [@rcarbon]. We calibrated the radiocarbon dates using the methods of @Bronk2008 and implemented in @rcarbon. To control for inconsistent sample size across the archaeological sites represented in the database, we aggregated radiocarbon dates known to be from the same phase of same archaeological site using the `rcarbon::binprep` function with an `h`-value of 100. We averaged probability densities of binned dates, and then constructed summed probability density (SPD) distributions across bins.


## 'Calibrating' tree-ring dates, and preparing tree-ring SPDs

```{r}
calibrate_tree_ring_dates <- function(x){
  out <- list(
    metadata = tibble::tibble(
      DateID = 1:length(x),
      CRA = x,
      Error = 0,
      Details = NA,
      CalCurve = "intcal13",
      ResOffsets = 0,
      ResErrors = 0,
      StartBP = 50000,
      EndBP = 0,
      Normalised = TRUE,
      F14C = FALSE,
      CalEPS = 1e-05
    ),
    grids = NA,
    calmatrix = 
      tibble::tibble(index = 1:length(x),
                     year_bp = x,
                     value = TRUE) %>%
      tidyr::pivot_wider(names_from = index,
                         values_from = value) %>%
      dplyr::bind_rows(tibble::tibble(year_bp = 50000:0)) %>%
      dplyr::filter(!duplicated(year_bp)) %>%
      dplyr::arrange(-year_bp) %>%
      dplyr::filter(year_bp >= 0) %>%
      tibble::column_to_rownames("year_bp") %>%
      as.matrix() %>%
      tidyr::replace_na(0) %>%
      magrittr::set_colnames(NULL)
  )
  
  attr(out,"class") <- c("CalDates", "list")
  
  return(out)
}

dendro_spd <-
  dendro_data %>%
  split(.,.$`Study Area`) %>%
  tibble::tibble(`Study Area` = names(.),
                 Dates = .) %>%
  dplyr::bind_rows(tibble::tibble(`Study Area` = "UUSW",
                                  Dates = list(dendro_data))) %>%
  dplyr::rowwise() %>%
  dplyr::mutate(Calibrated = list(Dates %$%
                                    calibrate_tree_ring_dates(x = Date_BP)),
                Bins = list(rcarbon::binPrep(sites = Dates$SiteID,
                                             ages = Dates$Date_BP,
                                             h = 100)),
                SPD = list(spd(x = Calibrated,
                               bins = Bins,
                               timeRange = c(1949,0),
                               runm = 21))) %>%
  
  dplyr::ungroup() %>%
  dplyr::mutate(Density = SPD %>%
                  purrr::map(function(x){
                    x$grid %>%
                      tibble::as_tibble() %$%
                      tibble::tibble(Type = "Tree-ring Density",
                                     Date_BP = calBP,
                                     Density = PrDens / sum(PrDens, na.rm = T))
                  })
  ) %T>%
  readr::write_rds("./data-derived/dendro_spd.rds",
                   compress = "gz")

dendro_spd <- readr::read_rds("./data-derived/dendro_spd.rds")

```

## Comparing radiocarbon and tree-ring SPDs

```{r}
all_density <- dendro_spd %>%
  dplyr::select(`Study Area`,Density) %>%
  tidyr::unnest(cols = c(Density)) %>%
  bind_rows(radiocarbon_spd %>%
              dplyr::select(`Study Area`,Density) %>%
              tidyr::unnest(cols = c(Density))) %>%
  dplyr::mutate(`Year AD` = 1950 - Date_BP) %>%
  dplyr::select(`Year AD`,
                Date_BP,
                `Study Area`,
                Type, 
                Density) %>%
  dplyr::rename(Value = Density)
```

```{r}
vep_demography <- 
  readxl::read_excel("./data-raw/vepii_demography_reconstructions.xlsx") %>%
  dplyr::rowwise() %>%
  dplyr::mutate(`Year AD` = list((Start+1):End)) %>%
  dplyr::select(`Study Area`,`Year AD`,Population) %>%
  tidyr::unnest(cols = c(`Year AD`)) %>%
  dplyr::mutate(Type = "Population",
                Date_BP = 1950 - `Year AD`) %>%
  dplyr::rename(Value = Population)
```

```{r}
all_density %>%
  dplyr::bind_rows(vep_demography) %>%
  dplyr::mutate(Type = factor(Type, 
                              levels = c("Radiocarbon Density",
                                         "Tree-ring Density",
                                         "Population"),
                              ordered = TRUE)#,
                # `Study Area` = ifelse(`Study Area` == "CMV", "Central Mesa Verde", "Northern Rio Grande")
  ) %>%
  ggplot(aes(x = `Year AD`)) +
  geom_line(aes(y = Value,
                color = `Study Area`),
            size = 1.25) +
  # coord_cartesian(xlim = c(600,1600)) +
  xlab("Year AD") +
  theme_minimal(24) +
  theme(legend.title = element_blank(),
        legend.justification = c(0, 1), 
        legend.position = "bottom",
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        plot.margin=unit(c(0.25,0.5,0.25,0.25),"in")
  ) +
  ggplot2::facet_wrap("Type", 
                      nrow = 3,
                      scales = "free_y")




ggsave("./output/c14_tr_pop.pdf",
       height = 10,
       width = 10)

```








```{r}
four_corners_lcc_proj <- "+proj=lcc +lat_1=37 +lon_0=-109.045225"

# Define the Bocinsky et al. 2016 study area
SWUS_bbox <- sf::st_bbox(c(xmin = -113,
                           xmax = -105,
                           ymin = 32,
                           ymax = 38), 
                         crs = 4326) %>%
  sf::st_as_sfc() %>%
  sf::st_set_crs(NA) %>%
  sf::st_segmentize(dfMaxLength = 0.01) %>%
  sf::st_set_crs(4326) %>%
  sf::st_transform(four_corners_lcc_proj)

four_corners_states <- "./data-raw/statesp010g/statesp010g.gdb/" %>%
  sf::st_read() %>%
  dplyr::filter(NAME %in% 
                  c("Arizona",
                    "Colorado",
                    "New Mexico",
                    "Utah")) %>%
  sf::st_transform(four_corners_lcc_proj)

swus_hillshade_500m <- readr::read_rds("./data-derived/swus_hillshade_500m.rds") %>%
  raster::crop(four_corners_states) %>%
  raster::mask(four_corners_states)

dendro_data <- sf::read_sf("./data-derived/dendro_data.geojson") %>%
  sf::st_transform(four_corners_lcc_proj) %>%
  dplyr::filter(Date_BP >= 550,
                Date_BP <= 1450) %>%
  dplyr::group_by(Site_Number) %>%
  dplyr::summarise(Date_BP = mean(Date_BP, na.rm = T),
                   geometry = mean(geometry)) %>%
  dplyr::mutate(`Date Type` = "Dendro") %>%
  dplyr::select(-Site_Number) %>%
  sf::st_centroid()

radiocarbon_data <- sf::read_sf("./data-derived/radiocarbon_data.geojson") %>%
  sf::st_transform(four_corners_lcc_proj) %>%
  dplyr::filter(Date_BP >= 550,
                Date_BP <= 1450) %>%
  dplyr::group_by(Site_Number) %>%
  dplyr::summarise(Date_BP = mean(Date_BP, na.rm = T)) %>%
  sf::st_jitter(20000) %>%
  dplyr::mutate(`Date Type` = "C14") %>%
  dplyr::select(-Site_Number) %>%
  sf::st_centroid()

dates <- rbind(dendro_data,
               radiocarbon_data)

theme_map <- function(base_size = 6.5, 
                      base_family = ""){
  ggplot2::theme_bw(base_size = base_size, 
                    base_family = base_family) %+replace%
    ggplot2::theme(axis.line = ggplot2::element_blank(),
                   axis.text = ggplot2::element_blank(),
                   axis.ticks = ggplot2::element_blank(),
                   axis.title = ggplot2::element_blank(),
                   panel.background = ggplot2::element_blank(),
                   panel.border = ggplot2::element_blank(),
                   panel.grid = ggplot2::element_blank(),
                   panel.grid.major = ggplot2::element_line(colour = 'transparent'),
                   panel.grid.minor = ggplot2::element_line(colour = 'transparent'),
                   legend.key = element_blank(),
                   legend.position = "top",
                   # legend.justification = c(0,0),
                   # legend.position = "top",
                   # legend.position = c(0.5,1),
                   # legend.background = ggplot2::element_blank(),
                   # legend.key.width = unit(0.15,"in"),
                   # legend.key.height = unit(0.15,"in"),
                   # legend.text = element_text(size = ggplot2::rel(1)),
                   plot.background = ggplot2::element_blank(),
                   plot.margin = ggplot2::margin(t = 0, r = 0, b = 0, l = 0, unit = "npc")
    )
}

ggplot() + 
  ggplot2::geom_sf(data = four_corners_states) +
  ggplot2::geom_raster(data = Robinson2020::swus_hillshade_500m,
                       mapping = ggplot2::aes(x = x,
                                              y = y,
                                              alpha = ID),
                       na.rm = TRUE) +
  ggplot2::scale_alpha(range = c(0.8, 0),
                       na.value = 0,
                       limits = c(0,255),
                       guide = "none") +
  ggplot2::geom_sf(data = four_corners_states,
                   fill = NA) +
  ggplot2::geom_sf(data = SWUS_bbox,
                   fill = NA) +
  ggplot2::geom_sf(data = dates,
                   mapping = aes(shape = `Date Type`,
                                 color = Date_BP),
                   show.legend = "point") +
  ggplot2::scale_shape(
    name = 'Date Type',
    solid = FALSE,
    guide = ggplot2::guide_legend(position = "top",
                                  direction = "horizontal",
                                  title.position = "top",
                                  label.position = "bottom")
  ) +
  viridis::scale_color_viridis(
    name = 'Year BP',
    limits = c(450,1450),
    breaks = c(450,1450),
    direction = -1,
    guide = ggplot2::guide_colorbar(position = "top",
                                    direction = "horizontal",
                                    title.position = "top",
                                    label.position = "bottom",
                                    reverse = TRUE)) +
  theme_map(16)

ggsave('./swus_sample_map.pdf',
       height = 8,
       width = 6)
```

