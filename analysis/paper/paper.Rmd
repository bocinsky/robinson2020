---
title: "Robinson et al. 2020 Supplemental Information: Comparing the Radiocarbon and Tree-ring Records for the Upland US Southwest"
author:
  - Kyle Bocinsky:
      email: bocinsky@gmail.com
      institute: [CCAC]
      correspondence: true
  - Erick Robinson:
      email: erick.robinson@usu.edu
      institute: [USU]
      correspondence: false
institute:
  - CCAC: Crow Canyon Archaeological Center
  - USU: Utah State University
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
    bookdown::html_document2:
      fig_caption: yes
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
    bookdown::pdf_document2:
      fig_caption: yes
      pandoc_args:
      - --lua-filter=../templates/scholarly-metadata.lua
      - --lua-filter=../templates/author-info-blocks.lua
      - --lua-filter=../templates/pagebreak.lua
bibliography: references.bib
csl: "../templates/philosophical-transactions-of-the-royal-society-b.csl" # Insert path for the bib-style
editor_options: 
  chunk_output_type: console
---

<!-- This is the format for text comments that will be ignored during renderings. Do not put R code in these comments because it will not be ignored. -->

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = "../figures/",
  dpi = 300
)

library(robinson2020)
```

# Summary of methods
Here, we directly compare two large collections of radiocarbon and tree-ring dates drawn from the Upland US Southwest --- roughly defined as the 'Four Corners' states of Arizona, Colorado, New Mexico, and Utah, but excluding the Phoenix and Tucson basins. 

After harmonizing those datasets to with one another and calibrating Radiocarbon dates are drawn from the [DARCY: DATABASE AND REFERENCE HERE], and are available [HERE]. Tree-ring data are those presented in @Bocinsky2016_SA and archived on the Digital Archaeological Record (https://doi.org/10.6067/XCV82J6D7B).

## Study Area

```{r}
four_corners_lcc_proj <- "+proj=lcc +lat_1=37 +lon_0=-109.045225"

# Define the Bocinsky et al. 2016 study area
UUSW <- robinson2020::uusw_boundary

# VEP study areas
vep_study_areas <- 
  list(CMV = robinson2020::vepii_cmv_boundary,
       NRG = robinson2020::vepii_nrg_boundary) %>%
  purrr::map(sf::st_transform,
             crs = 4326) %>%
  purrr::imap(~dplyr::mutate(.x,`Study Area` = .y)) %>%
  do.call(rbind, .)

UUSW_counties <- 
  tigris::counties(cb = TRUE, 
                   class = "sf",
                   progress_bar = FALSE) %>% 
  sf::st_transform(four_corners_lcc_proj) %>% 
  # sf::st_contains(UUSW, sparse = FALSE)
  dplyr::filter(sf::st_intersects(suppressWarnings(sf::st_centroid(.)),
                                  UUSW %>% 
                                    sf::st_transform(four_corners_lcc_proj), 
                                  sparse = FALSE)) %>%
  dplyr::select(NAME,STATEFP) %>%
  dplyr::rename(County = NAME) %>%
  dplyr::left_join(tigris::states(class = "sf",
                                  progress_bar = FALSE) %>%
                     dplyr::select(STATEFP,STUSPS) %>%
                     dplyr::rename(State = STUSPS) %>%
                     sf::st_drop_geometry(),
                   by = "STATEFP") %>%
  dplyr::select(-STATEFP) %>%
  tidyr::unite(col = County, County, State, sep = ", ")

```

## Datasets

## Preparing the radiocarbon data

```{r}
# # Read in the radiocarbon database
# radiocarbon_data <-
#   readr::read_csv(here::here("analysis/data/raw_data/0403_sbox_clean.csv")) %>%
#   # Convert to spatial object
#   sf::st_as_sf(coords = c("Long","Lat"),
#                crs = 4326) %>%
#   sf::st_transform(four_corners_lcc_proj) %>%
#   # Select salient columns
#   dplyr::select(labnumber,
#                 date,
#                 sd,
#                 Site,
#                 SiteID) %>%
#   dplyr::rename(Lab_Number = labnumber,
#                 Date_BP = date,
#                 SD = sd,
#                 Site_Number = Site) %>%
#   sf::st_intersection(UUSW_counties) %>%
#   sf::st_drop_geometry() %>%
#   dplyr::mutate(Type = "Radiocarbon",
#                 SiteID = SiteID %>% stringr::str_c("Radiocarbon - ", .)) %T>%
#   # Write the output to a new file (csv)
#   readr::write_csv(here::here("analysis/data/derived_data/radiocarbon_data.csv"))

radiocarbon_data <-
  readr::read_csv(here::here("analysis/data/derived_data/radiocarbon_data.csv"))

```

These data contain sensitive location information about cultural sites, and are restricted on tDAR. Accordingly, we pre-processed the data using the script below, and provide data as supplemental information without location information represented.
```{r}
# # Read in the Bocinsky et al. 2016 tree ring data
# # https://doi.org/10.6067/XCV82J6D7B
# dendro_data <-
#   readr::read_csv(here::here("analysis/data/raw_data/BOCINSKY_ET_AL_2015_TREE_RINGS.csv")) %>%
#   # Convert to spatial object
#   sf::st_as_sf(coords = c("LON","LAT"),
#                crs = 4326) %>%
#   sf::st_transform(four_corners_lcc_proj) %>%
#   # Convert dates to BP
#   dplyr::mutate(Date_BP = 1950 - Outer_Date_AD,
#                 Type = ifelse(C_Level %in% c(2,3),
#                               "Cutting or Near-cutting",
#                               "Non-cutting")) %>%
#   # drop C_Level
#   dplyr::select(Seq_Number,
#                 Site_Number,
#                 Lab_Number,
#                 Type,
#                 Date_BP) %>%
#   dplyr::rename(SiteID = Seq_Number) %>%
#   sf::st_intersection(UUSW_counties) %>%
#   sf::st_drop_geometry() %>%
#   dplyr::mutate(Type = Type %>% stringr::str_c("Dendro - ", .),
#                 SiteID = SiteID %>% stringr::str_c("Dendro - ", .),
#                 SD = 0) %>%
#   dplyr::filter(Type == "Dendro - Cutting or Near-cutting") %>%
#   dplyr::mutate(Type = "Tree-ring") %T>%
#   # Write the output to a new file (csv)
#   readr::write_csv(here::here("analysis/data/derived_data/dendro_data.csv"))

dendro_data <- 
  readr::read_csv(here::here("analysis/data/derived_data/dendro_data.csv"))

```

We draw on the tree-ring date database presented in @Bocinsky2016_SA and archived on the Digital Archaeological Record (https://doi.org/10.6067/XCV82J6D7B). Here, we use only the subset of those data 


# Combining datasets
```{r}
all_data <- list(Radiocarbon = radiocarbon_data,
                 `Tree-ring` = dendro_data) %>%
  purrr::map(~dplyr::mutate(.x,
                            `Study Area` = ifelse(County == "Montezuma, CO",
                                                  "CMV", 
                                                  NA),
                            `Study Area` = ifelse(County %in% c("Rio Arriba, NM",
                                                                "Sandoval, NM",
                                                                "Santa Fe, NM",
                                                                "Taos, NM"),
                                                  "NRG", 
                                                  `Study Area`)))

all_data %>%
  dplyr::bind_rows() %>%
  dplyr::group_by(Type,`Study Area`) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  tidyr::spread(Type, Count)

```

# Preparing the radiocarbon SPDs

```{r}
if(!file.exists(here::here("analysis/data/derived_data/radiocarbon_spd.rds")))
  all_data$Radiocarbon %>%
  split(.,.$`Study Area`) %>%
  tibble::tibble(`Study Area` = names(.),
                 Dates = .) %>%
  dplyr::bind_rows(tibble::tibble(`Study Area` = "UUSW",
                                  Dates = list(all_data$Radiocarbon))) %>%
  dplyr::rowwise() %>%
  dplyr::mutate(Calibrated = list(Dates %$%
                                    rcarbon::calibrate(x = Date_BP,
                                                       errors = SD,
                                                       calMatrix = TRUE,
                                                       normalised = TRUE,
                                                       verbose = FALSE)),
                Bins = list(rcarbon::binPrep(sites = Dates$SiteID,
                                             ages = Calibrated,
                                             h = 100)),
                SPD = list(rcarbon::spd(x = Calibrated,
                                        bins = Bins,
                                        timeRange = c(1949,0),
                                        runm = 21,
                                        verbose = FALSE))) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Density = SPD %>%
                  purrr::map(function(x){
                    x$grid %>%
                      tibble::as_tibble() %$%
                      tibble::tibble(Type = "Radiocarbon Density",
                                     Date_BP = calBP,
                                     Density = PrDens / sum(PrDens, na.rm = T))
                  })
  ) %>%
  readr::write_rds(here::here("analysis/data/derived_data/radiocarbon_spd.rds"),
                   compress = "gz")

radiocarbon_spd <- readr::read_rds(here::here("analysis/data/derived_data/radiocarbon_spd.rds"))

```

To prepare the radiocarbon dataset, we used functions provided by the *rcarbon* package for R [@rcarbon]. We calibrated the radiocarbon dates using the methods of @Bronk2008 and implemented in @rcarbon. To control for inconsistent sample size across the archaeological sites represented in the database, we aggregated radiocarbon dates known to be from the same phase of same archaeological site using the `rcarbon::binprep` function with an `h`-value of 100. We averaged probability densities of binned dates, and then constructed summed probability density (SPD) distributions across bins.


# 'Calibrating' tree-ring dates, and preparing tree-ring SPDs

```{r}
calibrate_tree_ring_dates <- function(x){
  out <- list(
    metadata = tibble::tibble(
      DateID = 1:length(x),
      CRA = x,
      Error = 0,
      Details = NA,
      CalCurve = "intcal13",
      ResOffsets = 0,
      ResErrors = 0,
      StartBP = 50000,
      EndBP = 0,
      Normalised = TRUE,
      F14C = FALSE,
      CalEPS = 1e-05
    ),
    grids = NA,
    calmatrix = 
      tibble::tibble(index = 1:length(x),
                     year_bp = x,
                     value = TRUE) %>%
      tidyr::pivot_wider(names_from = index,
                         values_from = value) %>%
      dplyr::bind_rows(tibble::tibble(year_bp = 50000:0)) %>%
      dplyr::filter(!duplicated(year_bp)) %>%
      dplyr::arrange(-year_bp) %>%
      dplyr::filter(year_bp >= 0) %>%
      tibble::column_to_rownames("year_bp") %>%
      as.matrix() %>%
      tidyr::replace_na(0) %>%
      magrittr::set_colnames(NULL)
  )
  
  attr(out,"class") <- c("CalDates", "list")
  
  return(out)
}

if(!file.exists(here::here("analysis/data/derived_data/dendro_spd.rds")))
  all_data$`Tree-ring` %>%
  split(.,.$`Study Area`) %>%
  tibble::tibble(`Study Area` = names(.),
                 Dates = .) %>%
  dplyr::bind_rows(tibble::tibble(`Study Area` = "UUSW",
                                  Dates = list(all_data$`Tree-ring`))) %>%
  dplyr::rowwise() %>%
  dplyr::mutate(Calibrated = list(Dates %$%
                                    calibrate_tree_ring_dates(x = Date_BP)),
                Bins = list(rcarbon::binPrep(sites = Dates$SiteID,
                                             ages = Dates$Date_BP,
                                             h = 100)),
                SPD = list(rcarbon::spd(x = Calibrated,
                                        bins = Bins,
                                        timeRange = c(1949,0),
                                        runm = 21,
                                        verbose = FALSE))) %>%
  
  dplyr::ungroup() %>%
  dplyr::mutate(Density = SPD %>%
                  purrr::map(function(x){
                    x$grid %>%
                      tibble::as_tibble() %$%
                      tibble::tibble(Type = "Tree-ring Density",
                                     Date_BP = calBP,
                                     Density = PrDens / sum(PrDens, na.rm = T))
                  })
  ) %>%
  readr::write_rds(here::here("analysis/data/derived_data/dendro_spd.rds"),
                   compress = "gz")

dendro_spd <- readr::read_rds(here::here("analysis/data/derived_data/dendro_spd.rds"))

```

## Comparing radiocarbon and tree-ring SPDs

```{r}
all_density <- 
  dendro_spd %>%
  dplyr::select(`Study Area`,Density) %>%
  tidyr::unnest(cols = c(Density)) %>%
  dplyr::bind_rows(radiocarbon_spd %>%
                     dplyr::select(`Study Area`,Density) %>%
                     tidyr::unnest(cols = c(Density))) %>%
  dplyr::mutate(`Year AD` = 1950 - Date_BP) %>%
  dplyr::select(`Year AD`,
                Date_BP,
                `Study Area`,
                Type, 
                Density) %>%
  dplyr::rename(Value = Density)
```

```{r}
vep_demography <- 
  robinson2020::vep_demography %>%
  dplyr::rowwise() %>%
  dplyr::mutate(`Year AD` = list((Start+1):End)) %>%
  dplyr::select(`Study Area`,`Year AD`,Population) %>%
  tidyr::unnest(cols = c(`Year AD`)) %>%
  dplyr::mutate(Type = "Population",
                Date_BP = 1950 - `Year AD`) %>%
  dplyr::rename(Value = Population)
```

```{r c14_tr_pop}
all_density %>%
  dplyr::bind_rows(vep_demography) %>%
  dplyr::mutate(Type = factor(Type, 
                              levels = c("Radiocarbon Density",
                                         "Tree-ring Density",
                                         "Population"),
                              ordered = TRUE)#,
                # `Study Area` = ifelse(`Study Area` == "CMV", "Central Mesa Verde", "Northern Rio Grande")
  ) %>%
  ggplot2::ggplot(ggplot2::aes(x = `Year AD`)) +
  ggplot2::geom_line(ggplot2::aes(y = Value,
                                  color = `Study Area`),
                     size = 1.25) +
  # coord_cartesian(xlim = c(600,1600)) +
  ggplot2::xlab("Year AD") +
  ggplot2::theme_minimal(24) +
  ggplot2::theme(legend.title = ggplot2::element_blank(),
                 legend.justification = c(0, 1), 
                 legend.position = "bottom",
                 axis.title.y = ggplot2::element_blank(),
                 axis.text.y = ggplot2::element_blank(),
                 panel.grid.major.y = ggplot2::element_blank(),
                 panel.grid.minor.y = ggplot2::element_blank(),
                 plot.margin = ggplot2::unit(c(0.25,0.5,0.25,0.25),"in")
  ) +
  ggplot2::facet_wrap("Type", 
                      nrow = 3,
                      scales = "free_y")

```








<!-- ```{r} -->
<!-- four_corners_lcc_proj <- "+proj=lcc +lat_1=37 +lon_0=-109.045225" -->

<!-- # Define the Bocinsky et al. 2016 study area -->
<!-- SWUS_bbox <- sf::st_bbox(c(xmin = -113, -->
<!--                            xmax = -105, -->
<!--                            ymin = 32, -->
<!--                            ymax = 38),  -->
<!--                          crs = 4326) %>% -->
<!--   sf::st_as_sfc() %>% -->
<!--   sf::st_set_crs(NA) %>% -->
<!--   sf::st_segmentize(dfMaxLength = 0.01) %>% -->
<!--   sf::st_set_crs(4326) %>% -->
<!--   sf::st_transform(four_corners_lcc_proj) -->

<!-- four_corners_states <- "./data-raw/statesp010g/statesp010g.gdb/" %>% -->
<!--   sf::st_read() %>% -->
<!--   dplyr::filter(NAME %in%  -->
<!--                   c("Arizona", -->
<!--                     "Colorado", -->
<!--                     "New Mexico", -->
<!--                     "Utah")) %>% -->
<!--   sf::st_transform(four_corners_lcc_proj) -->

<!-- swus_hillshade_500m <- readr::read_rds("./data-derived/swus_hillshade_500m.rds") %>% -->
<!--   raster::crop(four_corners_states) %>% -->
<!--   raster::mask(four_corners_states) -->

<!-- dendro_data <- sf::read_sf("./data-derived/dendro_data.geojson") %>% -->
<!--   sf::st_transform(four_corners_lcc_proj) %>% -->
<!--   dplyr::filter(Date_BP >= 550, -->
<!--                 Date_BP <= 1450) %>% -->
<!--   dplyr::group_by(Site_Number) %>% -->
<!--   dplyr::summarise(Date_BP = mean(Date_BP, na.rm = T), -->
<!--                    geometry = mean(geometry)) %>% -->
<!--   dplyr::mutate(`Date Type` = "Dendro") %>% -->
<!--   dplyr::select(-Site_Number) %>% -->
<!--   sf::st_centroid() -->

<!-- radiocarbon_data <- sf::read_sf("./data-derived/radiocarbon_data.geojson") %>% -->
<!--   sf::st_transform(four_corners_lcc_proj) %>% -->
<!--   dplyr::filter(Date_BP >= 550, -->
<!--                 Date_BP <= 1450) %>% -->
<!--   dplyr::group_by(Site_Number) %>% -->
<!--   dplyr::summarise(Date_BP = mean(Date_BP, na.rm = T)) %>% -->
<!--   sf::st_jitter(20000) %>% -->
<!--   dplyr::mutate(`Date Type` = "C14") %>% -->
<!--   dplyr::select(-Site_Number) %>% -->
<!--   sf::st_centroid() -->

<!-- dates <- rbind(dendro_data, -->
<!--                radiocarbon_data) -->

<!-- theme_map <- function(base_size = 6.5,  -->
<!--                       base_family = ""){ -->
<!--   ggplot2::theme_bw(base_size = base_size,  -->
<!--                     base_family = base_family) %+replace% -->
<!--     ggplot2::theme(axis.line = ggplot2::element_blank(), -->
<!--                    axis.text = ggplot2::element_blank(), -->
<!--                    axis.ticks = ggplot2::element_blank(), -->
<!--                    axis.title = ggplot2::element_blank(), -->
<!--                    panel.background = ggplot2::element_blank(), -->
<!--                    panel.border = ggplot2::element_blank(), -->
<!--                    panel.grid = ggplot2::element_blank(), -->
<!--                    panel.grid.major = ggplot2::element_line(colour = 'transparent'), -->
<!--                    panel.grid.minor = ggplot2::element_line(colour = 'transparent'), -->
<!--                    legend.key = element_blank(), -->
<!--                    legend.position = "top", -->
<!--                    # legend.justification = c(0,0), -->
<!--                    # legend.position = "top", -->
<!--                    # legend.position = c(0.5,1), -->
<!--                    # legend.background = ggplot2::element_blank(), -->
<!--                    # legend.key.width = unit(0.15,"in"), -->
<!--                    # legend.key.height = unit(0.15,"in"), -->
<!--                    # legend.text = element_text(size = ggplot2::rel(1)), -->
<!--                    plot.background = ggplot2::element_blank(), -->
<!--                    plot.margin = ggplot2::margin(t = 0, r = 0, b = 0, l = 0, unit = "npc") -->
<!--     ) -->
<!-- } -->

<!-- ggplot() +  -->
<!--   ggplot2::geom_sf(data = four_corners_states) + -->
<!--   ggplot2::geom_raster(data = Robinson2020::swus_hillshade_500m, -->
<!--                        mapping = ggplot2::aes(x = x, -->
<!--                                               y = y, -->
<!--                                               alpha = ID), -->
<!--                        na.rm = TRUE) + -->
<!--   ggplot2::scale_alpha(range = c(0.8, 0), -->
<!--                        na.value = 0, -->
<!--                        limits = c(0,255), -->
<!--                        guide = "none") + -->
<!--   ggplot2::geom_sf(data = four_corners_states, -->
<!--                    fill = NA) + -->
<!--   ggplot2::geom_sf(data = SWUS_bbox, -->
<!--                    fill = NA) + -->
<!--   ggplot2::geom_sf(data = dates, -->
<!--                    mapping = aes(shape = `Date Type`, -->
<!--                                  color = Date_BP), -->
<!--                    show.legend = "point") + -->
<!--   ggplot2::scale_shape( -->
<!--     name = 'Date Type', -->
<!--     solid = FALSE, -->
<!--     guide = ggplot2::guide_legend(position = "top", -->
<!--                                   direction = "horizontal", -->
<!--                                   title.position = "top", -->
<!--                                   label.position = "bottom") -->
<!--   ) + -->
<!--   viridis::scale_color_viridis( -->
<!--     name = 'Year BP', -->
<!--     limits = c(450,1450), -->
<!--     breaks = c(450,1450), -->
<!--     direction = -1, -->
<!--     guide = ggplot2::guide_colorbar(position = "top", -->
<!--                                     direction = "horizontal", -->
<!--                                     title.position = "top", -->
<!--                                     label.position = "bottom", -->
<!--                                     reverse = TRUE)) + -->
<!--   theme_map(16) -->

<!-- ggsave('./swus_sample_map.pdf', -->
<!--        height = 8, -->
<!--        width = 6) -->
<!-- ``` -->

<!-- The following line inserts a page break  -->
\newpage

# References 
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

\newpage

### Colophon

This report is part of a research compendium developed using the `rrtools` package for reproducible research [@Marwick2017, @rrtools]. This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
if ("devtools" %in% installed.packages()) devtools::session_info()
```

The current Git commit details are:

```{r}
# what commit is this file at? 
if ("git2r" %in% installed.packages() & git2r::in_repository(path = ".")) git2r::repository(here::here())  
```
